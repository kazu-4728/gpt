name: slides
on:
  issue_comment:
    types: [created]
permissions:
  contents: write
  pull-requests: write
  issues: write
concurrency:
  group: slides-${{ github.event.issue.number || github.run_id }}
  cancel-in-progress: true
jobs:
  build:
    if: >
      github.event.issue.pull_request != null &&
      (github.event.comment.author_association == 'MEMBER' || github.event.comment.author_association == 'OWNER') &&
      startsWith(github.event.comment.body, '/slides')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Resolve PR context
        id: ctx
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.issue.number;
            const {data: pr} = await github.rest.pulls.get({ owner: context.repo.owner, repo: context.repo.repo, pull_number: prNumber });
            core.setOutput('number', String(prNumber));
            core.setOutput('branch', pr.head.ref);
            core.setOutput('title', pr.title ?? 'Slides');

      - run: |
          git fetch origin "${{ steps.ctx.outputs.branch }}"
          git checkout "${{ steps.ctx.outputs.branch }}"

      - uses: ./.github/actions/common-setup
        with: { npm: "true", apt: "true" }

      - name: Build slides (Marp)
        run: |
          set -e
          if   [ -f "PRFAQ_1pager.md" ]; then SRC="PRFAQ_1pager.md";
          elif [ -f "next_actions_v1.md" ]; then SRC="next_actions_v1.md";
          else echo "No PRFAQ_1pager.md or next_actions_v1.md"; exit 1; fi
          {
            echo '---'
            echo 'marp: true'
            echo 'paginate: true'
            echo 'size: 16:9'
            echo "title: ${{ steps.ctx.outputs.title }}"
            echo '---'
            awk '{ if ($0 ~ /^##[[:space:]]+/) {print "\n---"; print $0} else {print $0} }' "$SRC"
          } > slides.md
          marp --pdf slides.md -o slides.pdf
          marp --html slides.md -o slides.html

      - uses: actions/upload-artifact@v4
        with:
          name: slides-pr-${{ steps.ctx.outputs.number }}
          path: |
            slides.md
            slides.pdf
            slides.html
          retention-days: 14

      - uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner, repo: context.repo.repo,
              issue_number: Number("${{ steps.ctx.outputs.number }}"),
              body: "ğŸï¸ Slides generated â†’ Actions â†’ Artifacts ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
            });
